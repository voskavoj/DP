import subprocess

IRIDIUM_PARSER_PATH = "GNURadio/iridium-toolkit/iridium-parser.py"
IRA_BASE_FREQUENCY = 1626270800

foo = """
RAW: i-289693-t1 0025108.8066 1626314368 N:30.79-90.82 I:00000004990  91% 0.03363 107 0011000000110000111100111111110101001101101110011010010000001000111101100000100011100001011101111000100000010010001111101010110011111001110100001101010010010001100110100101111010110110110011001111100111010000110101001001000110011000110001
RAW: i-289693-t1 0025108.8072 1626147712 N:35.33-90.61 I:00000004980  98% 0.06057 105 001100000011000011110011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000101001111011110100110101110100101101000011011000000110111001000001011011100101010001111000010111010101010011010110
RAW: i-289693-t1 0025152.4145 1624939392 N:22.57-135.53 I:00000005010  91% 0.00011 179 0011000000110000111100111111000101000101111011011011001101001001101100101111101010111001000001000000000101001100010000001101000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000010001100010000001000110001001100000010001100100001
RAW: i-289693-t1 0025199.2752 1625106048 N:21.56-131.81 I:00000005040  94% 0.00013 179 0011000000110000111100110001000110110011000000100000001001100011001000010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
RAW: i-289693-t1 0025201.1908 1625564288 N:23.37-117.38 I:00000005030  63% 0.00055 146 0011000000110000111100101000000110010010101101110111110011011101001110111011011111110111001110010001101101000111000011000110010000001010100100011000001000010010000000010111001111100000000010111100101001000110010101101100111000000001011100111110000000001011110010100001011001110010110011000110110000000000001011000010
RAW: i-289693-t1 0025201.1949 1625231104 N:25.95-128.61 I:00000005020  72% 0.00012 143 0011000000110000111100110000001011001111111100100001100011010101001110110111111110110111001110111001001100010111100010101110010000001110101110111000001000000010000000010111001111100000000010111100101001000110011100100101111000000001011100111110000000001011110010100100011001110010110011101101001101010001110100
RAW: i-289693-t1 0025262.7601 1625064448 N:26.71-131.82 I:00000005080  89% 0.00015 139 00110000001100001111001100100010000000010011000000000010001000110000000101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101110101100001
RAW: i-289693-t1 0025262.7638 1625106048 N:25.74-131.17 I:00000005090  90% 0.00013 140 0011000000110000111100110001000110110111000000100000001001100011100101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010111010000011001
RAW: i-289693-t1 0025286.0537 1626314368 N:22.02-90.39 I:00000005110  75% 0.01579 120 001100000011000011110011101101000101100100111011101011110001010011100110000010000101000111110111100010000001001000111110101000011000110011110000001101110000010000100011001001111000011011111111111111111111111111111111111111111111111111111111111111111001011101011001
RAW: i-289693-t1 0025375.7536 1625064320 N:25.36-130.98 I:00000005130  89% 0.00014 179 0011000000110000111100111001100000010011000100000000001000101011001010010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
RAW: i-289693-t1 0025375.7547 1625106048 N:24.04-130.45 I:00000005140  79% 0.00012 179 0011000000110000111100110001000110111110000000100000001001100011000000001101010101010101010101010101010101010101010101010101011100010101010101010101110001010101010101010101010101010101010101010101010101010101010101010101001101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010011010101010100
RAW: i-289693-t1 0025439.2544 1625064320 N:19.84-130.86 I:00000005170  83% 0.00012 179 0011000000110000111100110001000110111111000000100000001000100011000100010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010011010101010101010101010101010101010101010101010101010101001101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101
RAW: i-289693-t1 0025439.2602 1625105920 N:21.34-129.98 I:00000005190  69% 0.00010 179 0011000000110110111100111011000110111111110000100000001001100011100100010101010101010101010101010101010111010001010101010101010101010101010101010101010011010100110101010101010101010100110011010101010101010101010101010101010101010101010101010101010101010101010101010101010101010011010101010101010101010101010101010101010101111011010101010101010101010101010100110101010101010101010101
RAW: i-289693-t1 0025441.1797 1625231104 N:19.67-127.02 I:00000005180  61% 0.00011 124 00110000001100001111001100000010110101111111001000111101110111000011101101111111010101111011000011000011001110101001100010100010100100111111001101000111000100100000000101110101111000000000101111001010010100100111001011001100001000010111001111100000000011101100101001000110
RAW: i-289693-t1 0025441.1811 1625564416 N:20.51-115.12 I:00000005160  44% 0.00045  44 0011001001110000110101110000000110011110011100101101110101011101001110111011011000110110001100010100100000111101
RAW: i-289693-t1 0025462.3764 1626147712 N:22.08-89.43 I:00000005200  91% 0.02384 389 0011000000110000111100111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001100010101111101111011101000110101110011110110101100100011001011111011110110001101100111001000111101000011110111011101100100010100100000011100000100010111110001101000010101000011000000111101101011010110101000100011110101011010101101100110000101010011010000000110111111101011011000110010001101001011000111000111001111001101000011100000101110110111101010111000101101001101101011001111010100100101011100100110100001111110000110110101010101010001010100101001111100011100001110011110010000011100110011100000010110100100001101011011000111001010101111100011110100110001101001101101110011010111101011000111101010010001001001110110111111110011111001100000111010001000100101111111111000100011
RAW: i-289693-t1 0025502.6286 1625106048 N:18.51-129.77 I:00000005220  56% 0.00009  41 0011000000110000111010100000000111101101100001100000001001100011101000010101010100011101010111011011101101
RAW: i-289693-t1 0029664.7720 1626480768 N:19.35-85.58 I:00000005250  71% 0.01548 118 00110000001100001111000101110011111100110011001111110001110110010001010100100100001100010010100100001110010000001000101000010000000100010000000000000010010000000000000000100011001100001100110011001100110011001100110011001100110011001100110011001100100101110000
RAW: i-289693-t1 0029777.9890 1626480640 N:18.29-85.70 I:00000005260  71% 0.01507 130 00110000001100001101011100110011111100110011001111110011010010100000011100110100001111100010101010010110111001001000101000000000000000000000000000000000000000000000000000000000000000001110100011000100100011001100110001011100110011001100110011001100100100101001011110001001001010110000
RAW: i-289693-t1 0031521.2394 1626445184 N:21.52-86.43 I:00000005270  81% 0.01876 125 0011000000110000111100110011001111110011001100111111001110010111101100010000000100110001000000011000101101101100100011100000000000000000000000000000000000000000000000000000000000000000110011001100110011001100110011001100110011000101110011001100110010010111000101110100100000
RAW: i-289693-t1 0033610.8462 1626480512 N:19.08-86.53 I:00000005280  68% 0.01661 432 001100000011100010110011010100000001100000010010111000011101111001010110011110100010011110000111111100001001110010101000000110011111101000011001100100100100110110010110011101011000011111101101011011000000001000000000000101100110000001100000000000100101001101011001111111111101001000000000010000000110001000111001001101101101000000000010101110001110111100101111000001100001100000110110111110011001100111100111010011010110111100011111100111111111111101101110000011100011011101101011001011110111111001101111010000001001101111111111100000101011010111000000001001100110111111111101111101000011011011100111000001100010011111111111111111111111011010110111011111011111100000100010010000011011111101101111111111110000111101101001100110011111100010011010011011110011011001000001010111010100000000101111111111110010111111101010101001101000011001000011010011100101100001000000001001101001010100010100
"""


def _parse_ira_frames(frames):
    """
    Parse iridium frames from a string or a list.

    :param frames: iridium frames
    :return: parsed frames
    """

    if isinstance(frames, list):
        frames = "\n".join(frames)

    prc = subprocess.run(["python", IRIDIUM_PARSER_PATH],
                         input=frames, text=True, capture_output=True)

    if prc.returncode != 0:
        print("Error in parsing iridium frames")
        print(prc.stdout)
        print(prc.stderr)
        return None

    # filter IRA frames
    parsed_ira_frames = [line for line in prc.stdout.split("\n") if line.startswith("IRA")]
    decomposed_ira_frames = list()

    if not parsed_ira_frames:
        print("No IRA frames found")
    else:
        for ira_frame in parsed_ira_frames:
            if decomposed := _decompose_ira_frame(ira_frame):
                decomposed_ira_frames.append(decomposed)

    return decomposed_ira_frames


def _decompose_ira_frame(ira_frame):
    """
    Decompose an ira frame into its components.

    :param ira_frame: ira frame
    :return: satellite id, satellite latitude, satellite longitude
    """
    if len(ira_frame) < 137:
        print("IRA frame too short")
        return False

    try:
        tx_freq = int(ira_frame[34:44])
        sat_id = int(ira_frame[82:85])
        sat_lat = float(ira_frame[123:129])
        sat_lon = float(ira_frame[130:137])
    except ValueError:
        print("IRA frame could not be parsed: ", ira_frame)
        return False

    doppler = (tx_freq - IRA_BASE_FREQUENCY) / IRA_BASE_FREQUENCY

    return sat_id, doppler, sat_lat, sat_lon


def identify_transmitting_iridium_satellites(frames, require_one=False):
    decomposed_ira_frames = _parse_ira_frames(frames)
    if not decomposed_ira_frames:
        return None

    tx_sats = dict()
    for x in decomposed_ira_frames:
        tx_sats[x[0]] = x
    tx_sats = list(tx_sats.values())

    if require_one and len(tx_sats) != 1:
        print(f"Found {len(tx_sats)} transmitting satellites")
        return False
    elif require_one:
        return tx_sats[0]
    else:
        return tx_sats


print(identify_transmitting_iridium_satellites(foo))
